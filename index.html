<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
    <style>
      h2 {
        color: black;
        text-align: center;
      }

      p {
  		margin-left: 120px;
  		font-size:5;
  	  }

      .axis {
        font-family: arial;
        font-size: 0.6em;
      }

      path {
        fill: none;
        stroke: black;
        stroke-width: 2px;
      }

      .tick {
        fill: none;
        stroke: black;
      }

      circle {
        opacity: 0.4;
        stroke: none;
      }

      .line_plot {
        fill: none;
        stroke: #4eb0bb;
        stroke-width: 1px;
      }

      div.bottons{
        position: fixed;
        top: 600px;
        left: 100px;
      }

      div.bottons div {
        background-color: rgb(251, 201, 127);
        padding: 3px;
        margin: 7px;
        display: inline;
      }

    </style>

    <script type="text/javascript">
      format = d3.time.format("%Y-%m-%d %H:%M:%S");


      function draw(data) {
        "use strict";
        var margin = 75,
            width = 1100 - margin,
            height = 500 - margin;

        var radius = 5,
            color = 'blue';
//            multiplier = 2;
        //head
        d3.select("body")
            .append("h2")
            .text("Prosper Listing Creation's Time Trends");

        d3.select("body")
            .append('p')
            .text("对图表的内容描述")

        //svg
        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g')
            .attr('class', 'chart');


        d3.select('svg')
            .selectAll("circle")
            .data(data)
            .enter()
            .append("circle")

        //debugger;
        //gen grouped data
        var listsby_year = d3.nest()
                       .key(function(d) {
                         return d['ListingCreationDate'].getUTCFullYear();
                       })
                       .rollup(function(v) {return v.length; })
                       .entries(data);

        var listsby_month = d3.nest()
                       .key(function(d) {
                         return d['ListingCreationDate'].getUTCMonth();
                       })
                       .rollup(function(v) {return v.length; })
                       .entries(data);

        var listsby_hour = d3.nest()
                       .key(function(d) {
                         return d['ListingCreationDate'].getUTCHours();
                       })
                       .rollup(function(v) {return v.length; })
                       .entries(data);

        //var lists = ["listsby_year":[listsby_year],
        //            "listsby_month":[listsby_month], "listsby_hour":[listsby_hour]];

/*
        var grade = d3.nest()
                       .key(function(d) {
                         return d['credit_and_prosper_grade'];
                       })
                       .rollup(function(v) {return v.length; })
                       .entries(data);

        //var jobstatus = d3.nest()
                       .key(function(d) {
                         return d['EmploymentStatus'];
                       })
                       .rollup(function(v) {return v.length; })
                       .entries(data);
*/
        debugger;

        //x and y scale
        var x_extent = d3.extent(listsby_year, function(d) {
            return d.key;
        });

        var x_scale = d3.scale.linear()
            .range([margin, width])
            .domain(x_extent);

        var y_extent = d3.extent(listsby_year, function(d) {
            return d.values;
        });

        var y_scale = d3.scale.linear()
            .range([height, margin])
            .domain(y_extent);

        // x and y axis
        var x_axis_gen = d3.svg.axis()
            .scale(x_scale)
            .ticks(9);

        var x_axis = d3.select("svg")
            .append('g')
            .attr('class', 'x axis')
            .attr('transform', "translate(0," + height + ")")
            .call(x_axis_gen);

        var y_axis_gen = d3.svg.axis()
            .scale(y_scale)
            .orient("left");

        var y_axis = d3.select("svg")
            .append('g')
            .attr('class', 'y axis')
            .attr('transform', "translate(" + margin + ",0)")
            .call(y_axis_gen);

        var y_axis_text = y_axis.append("text")
            .text("Num of Listings")
            .attr("x",5)
            .attr("y",70)
            .attr("dy","1em");

        //circle
        var circle_groups = svg.selectAll('.circle')
            .data(listsby_year)
            .enter()
            .append('g')
            .attr('class', 'circle')

        var circles = circle_groups.append('circle')
            .attr('cx', function(d) {
                return x_scale(d.key);
            })

            .attr('cy', function(d) {
                return y_scale(d.values);
            })
            .attr('r', radius)
            .attr('fill', color);


        //text under circle groups
		    var texts = circle_groups.append('text')
			      .text(function(d) {
                return d.values;
            })
			      .attr("x",function(d) {
                return x_scale(d.key);
            })
			      .attr("y",function(d) {
                return y_scale(d.values)-10;
            })
			      .attr("visibility", "hidden");

		    //circle group activity
		    circle_groups.on("mouseover", function(d){
				    this.getElementsByTagName('text')[0].style.visibility = "visible"
			  })
			      .on("mouseout", function(d){
			      this.getElementsByTagName('text')[0].style.visibility = "hidden"
			  });

		    //line generator
		    var line_generator = d3.svg.line()
			      .x(function(d){
				    return x_scale(d.key);
			  })
			      .y(function(d){
				    return y_scale(d.values);
			  });
		    //line
		    var line = svg.append("path")
			      .attr('d', line_generator(listsby_year))
			      .attr('stroke', 'green')
			      .attr('stroke-width', 2)
			      .attr('fill', 'none');

        //debugger;

        //update
    function update_axis(metric) {
        y_extent = d3.extent(listsby_month, function(d){
            return d.values;
        })
        x_extent = d3.extent(listsby_month, function(d){
            return d.key;
        })
        y_scale = d3.scale.linear()
            .range([height, margin])
            .domain(y_extent)
        x_scale = d3.scale.linear()
            .range([margin, width])
            .domain(x_extent)
        y_axis_gen = d3.svg.axis()
            .scale(y_scale)
            .orient("left")
        x_axis_gen = d3.svg.axis()
            .scale(x_scale)
            .ticks(11);
        x_axis.transition()
            .duration(500)
            .call(x_axis_gen)
        y_axis_gen = d3.svg.axis()
            .scale(y_scale)
            .orient("left")
        y_axis.transition()
            .duration(500)
            .call(y_axis_gen)

    }

    function update_circles(metric) {
        circles.transition()
            .duration(500)
            .attr("cx", function(d) {
                return x_scale(d.key);
            })
            .attr("cy", function(d) {
                return y_scale(d.values);
            })
        texts.text(function(d) {
                return x_scale(d.key);
            })
            .attr("x", function(d) {
                return x_scale(d.key);
            })
            .attr("y", function(d) {
                return y_scale(d.values)-10;
            })
            .attr("visibility", "hidden");
    }

    function update_line(metric) {
        line_generator = d3.svg.line()
            .x(function(d) {
                return x_scale(d.key);
            })
            .y(function(d) {
                return y_scale(d.values);
            })
            line.transition()
                .duration(500)
                .attr('d', line_generator(listsby_month))
                .attr('stroke', 'green')
                .attr('stroke-width', 2)
                .attr('fill', 'none');
    }

    function update(metric) {
            update_axis(metric);
            update_circles(metric);
            update_line(metric);
    }

        var metriclist = [{"btn_text":"Year Trends", "list":"listsby_year"},
                          {"btn_text":"Month Trends", "list":"listsby_month"},
                          {"btn_text":"Hour Trends", "list":"listsby_hour"}];

        //button
        var buttons = d3.select("body")
            .append("div")
            .attr("class", "bottons")
            .selectAll("div")
            .data(metriclist)
            .enter()
            .append("div")
            .attr("class", "botton")
            .text(function(d) {
                return d["btn_text"];
            })
            .style("color", "black")
            .style("blackground", "rgb(251, 201, 127)");

        d3.select(".bottons").select("div").style("background", "lightBlue")
            .style("color", "white");

        buttons.on("click", function(d) {
            d3.select(".bottons")
                .selectAll("div")
                .transition()
                .duration(500)
                .style("color", "black")
                .style("background", "rgb(251, 201, 127)");

            d3.select(this)
                .transition()
                .duration(500)
                .style("background", "lightBlue")
                .style("color", "white");
            update(d["list"]);
        });

      };
    </script>
  </head>
  <body>
    <script type="text/javascript">

    d3.csv("prosperloan_reduced.csv", function(d) {
        //d['ProsperPaymentsOneMonthPlusLate'] = +d['ProsperPaymentsOneMonthPlusLate'];
        d['ListingCreationDate'] = format.parse(d['ListingCreationDate'].slice(0, 19));
        //debugger;
        return d;
      }, draw);
    </script>
  </body>
  </html>
